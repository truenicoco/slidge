image: alpine/edge
packages:
  - poetry
secrets:
  - 3ecea679-dec7-4ac0-8821-75d0f4fe0773
  - dc710d9d-8043-4e1d-9837-b35bfa02800a
artifacts:
  - ./docs.tar.gz
  - ./package.tar.gz
  - ./package.whl
  - ./coverage.tar.gz
tasks:
  - set-project: |
      echo PROJECT=$(ls ~) >> ~/.buildenv
  - install: |
      cd $PROJECT
      poetry install
      poetry run c3p0 $PROJECT
      poetry run set_version
      poetry build
      cp dist/*.tar.gz ~/package.tar.gz
      cp dist/*.whl ~/package.whl
  - tests: |
      cd $PROJECT
      poetry run coverage run -m pytest tests
      poetry run coverage report
      poetry run coverage html
      cd htmlcov
      tar czf ~/coverage.tar.gz .
  - lint: |
      cd $PROJECT
      poetry run ruff $PROJECT
      poetry run mypy $PROJECT
      poetry run black --check $PROJECT
      poetry run isort --check $PROJECT
  - docs: |
      cd $PROJECT/docs
      make html
      cd build/html
      tar cvzf ~/docs.tar.gz .
  - publish: |
      if [ -z "$PYPI" ]; then
        echo Not a release, no publishing
        exit
      fi

      set +x
      export POETRY_PYPI_TOKEN_PYPI=$(cat ~/.pypi-token)
      set -x

      cd $PROJECT
      poetry publish
