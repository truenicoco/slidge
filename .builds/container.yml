image: archlinux
packages:
  - docker
  - docker-buildx
secrets:
  - 173244e1-c233-43de-969f-65965c5487e1
tasks:
  - setup-docker1: |
      sudo systemctl start docker
      sudo usermod -aG docker build
  - setup-docker2: |
      while ! test -e /var/run/docker.sock; do sleep 1; done
      docker run --rm --privileged multiarch/qemu-user-static --reset -p yes -c yes
      docker buildx create --use
  - build: |
      cd slidge
      ARGS="--push --platform linux/amd64,linux/arm64"
      for TARGET in builder base dev; do
        docker buildx build . \
          --tag docker.io/nicocool84/slidge-$TARGET \
          --target $TARGET \
          $ARGS
      done
