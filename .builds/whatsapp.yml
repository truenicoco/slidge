image: alpine/edge
packages:
  - python3-dev
  - docker
  - docker-cli-buildx
sources:
  - https://git.sr.ht/~nicoco/slidge
secrets:
  - 3ecea679-dec7-4ac0-8821-75d0f4fe0773
  - 173244e1-c233-43de-969f-65965c5487e1
  - 600fb955-af99-4541-a28e-44879f4b2cfc
  - dc710d9d-8043-4e1d-9837-b35bfa02800a
environment:
  REGISTRY_PREFIX: docker.io/nicocool84/slidge
  PLUGINS: whatsapp
  DOCKER_BUILDKIT: "1"
artifacts:
  - ./slidge/dist/slidge-0.0.0.dev0-py3-none-any.whl
  - ./slidge/dist/slidge-0.0.0.dev0.tar.gz
tasks:
  - setup-poetry: |
      curl -sSL https://install.python-poetry.org | python3 -
      sudo ln -s /home/build/.local/bin/poetry /usr/local/bin
      cd slidge
      poetry install --all-extras
      poetry build
  - muc-bot: |
      cd slidge
      poetry run python .builds/muc_bot.py || true  # let's not block if this fails
  - mypy: |
      cd slidge
      poetry run mypy slidge
  - pytest: |
      cd slidge
      poetry run pytest tests
  - black: |
      cd slidge
      poetry run black --check slidge
  - docker-setup: |
      sudo service docker start
      sudo addgroup build docker
  - container: |
      cd slidge
      while ! test -e /var/run/docker.sock; do sleep 1; done
      docker run --rm --privileged multiarch/qemu-user-static --reset -p yes -c yes
      docker buildx create --use
      for LEGACY in $PLUGINS; do
        export NAME=$REGISTRY_PREFIX-$LEGACY:latest
        export ARGS="--cache-from $NAME --platform linux/arm64,linux/amd64 --tag $NAME --target slidge-$LEGACY ."
        docker buildx build $ARGS
        if [ "$(git rev-parse master)" = "$(git rev-parse HEAD)" ]; then
          docker buildx build --push $ARGS
        fi
      done
  - release: |
      cd slidge
      for TAG in $(git tag --points-at HEAD); do
        if [[ $TAG == v* ]] ; then
          VER=$(echo $TAG | cut -c2-)
          for LEGACY in $PLUGINS; do
            docker buildx build \
              --push \
              --platform linux/arm64,linux/amd64 \
              --tag $REGISTRY_PREFIX-$LEGACY:$VER \
              --target slidge-$LEGACY .
          done
        fi
      done
