image: debian/stable

packages:
  - devscripts
  - debhelper-compat
  - dwz
  - python3-dev
  - libffi-dev
  - cython3
  - dh-virtualenv
  - ca-certificates
  - golang-src/bullseye-backports
  - golang-go/bullseye-backports

repositories:
  bullseye-backports: http://deb.debian.org/debian bullseye-backports main

environment:
  DEBFULLNAME: IGImonster
  EMAIL: igimonster@mailbox.org
  GOBIN: /tmp/gobin
  PLUGINS: facebook signal telegram skype hackernews mattermost steam discord whatsapp
  POETRY_EXTRAS: facebook signal telegram skype mattermost steam discord

artifacts:
  - slidge-debian-amd64.tar
  - slidge-latest-amd64.deb

tasks:
  - version: |
      cd slidge
      echo VER=$(date +"%Y%m%d")-git-$(git rev-parse HEAD | cut -c1-5) >> ~/.buildenv
      for TAG in $(git tag --points-at HEAD); do
        if [[ $TAG == v* ]] ; then
          echo VER=$(echo $TAG | cut -c2-) >> ~/.buildenv
        fi
      done
  - export-requirements: |
      # https://github.com/python-poetry/poetry/issues/5241
      sudo apt-get remove python3-virtualenv -y
      curl -sSL https://install.python-poetry.org | python3 -
      cd slidge
      ~/.local/bin/poetry export $(for p in $POETRY_EXTRAS; do echo -n "-E $p "; done) -o requirements.txt
      sudo apt-get install python3-virtualenv dh-virtualenv -y
  - generate-gopy: |
      go install github.com/go-python/gopy@latest
      go install golang.org/x/tools/cmd/goimports@latest
      sudo mv $GOBIN/gopy $GOBIN/goimports /usr/local/bin
      sudo python3 -m pip install pybindgen
      find slidge -name go.mod -execdir gopy build -vm=python3 -output=generated -no-make=true . ';'
  - generate-plugin-files: |
      cd slidge/debian
      mkdir -p etc
      for PLUGIN in $PLUGINS; do
        sed "s/--PLUGIN--/$PLUGIN/" tpl.conf > etc/$PLUGIN.conf.example
      done
      echo "socket=/var/run/signald/signald.sock" >> etc/signal.conf.example
  - build: |
      cd slidge
      cp ./LICENSE ./debian/copyright
      debchange --create "Autogenerated" --newversion=$VER --package "slidge"
      # git checkout -B debian-package
      # gbp dch --release --debian-branch debian-package
      dpkg-buildpackage -us -uc -b
  - test: |
      sudo apt-get install ./slidge_${VER}_amd64.deb -y
      ls -la /usr/lib/slidge*
      sudo ls -la /etc/slidge*
      sudo mv /etc/slidge/conf.d/common.conf.example /etc/slidge/conf.d/common.conf
      sudo mv /etc/slidge/mattermost.conf.example /etc/slidge/mattermost.conf
      sudo systemctl cat slidge@mattermost.service
      slidge --help
      sudo systemctl enable --now slidge@mattermost
      sleep 5
      sudo journalctl -u slidge@mattermost --since yesterday
      sudo apt remove slidge -y
      sudo ls -la /etc/slidge
      sudo ls -la /var/lib/slidge
      sudo apt remove slidge --purge -y
      if grep -q slidge /etc/passwd; then false; else true; fi
      [[ ! -d /var/lib/slidge ]]
      [[ ! -d /etc/slidge ]]
  - tar: |
      tar cf slidge-debian-amd64.tar slidge-* slidge_*
      mv slidge_${VER}_amd64.deb slidge-latest-amd64.deb
