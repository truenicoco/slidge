image: debian/unstable
arch: arm64

packages:
  - binutils
  - devscripts
  - debhelper-compat
  - dwz
  - python3-dev
  - libffi-dev
  - dh-virtualenv
  - python3-poetry
  - python3-setuptools
  - python3-pip
  - golang-src
  - golang-go

environment:
  DEBFULLNAME: IGImonster
  EMAIL: igimonster@mailbox.org
  GOBIN: /tmp/gobin
  PLUGINS: facebook signal skype hackernews mattermost steam discord whatsapp
  POETRY_EXTRAS: facebook signal skype mattermost steam discord

artifacts:
  - slidge-debian-arm64.tar
  - slidge-latest-arm64.deb

tasks:
  - version: |
      cd slidge
      echo VER=$(date +"%Y%m%d")-git-$(git rev-parse HEAD | cut -c1-5) >> ~/.buildenv
      for TAG in $(git tag --points-at HEAD); do
        if [[ $TAG == v* ]] ; then
          echo VER=$(echo $TAG | cut -c2-) >> ~/.buildenv
        fi
      done
  - export-requirements: |
      cd slidge
      sudo poetry self add poetry-plugin-export
      poetry export $(for p in $POETRY_EXTRAS; do echo -n "-E $p "; done) -o requirements.txt
  - generate-gopy: |
      go install github.com/go-python/gopy@latest
      go install golang.org/x/tools/cmd/goimports@latest
      sudo mv $GOBIN/gopy $GOBIN/goimports /usr/local/bin
      sudo python3 -m pip install pybindgen
      find slidge -name go.mod -execdir gopy build -vm=python3 -output=generated -no-make=true . ';'
  - generate-plugin-files: |
      cd slidge/debian
      mkdir -p etc
      for PLUGIN in $PLUGINS; do
        sed "s/--PLUGIN--/$PLUGIN/" tpl.conf > etc/$PLUGIN.conf.example
      done
      echo "signald-socket=/var/run/signald/signald.sock" >> etc/signal.conf.example
  - build: |
      cd slidge
      cp ./LICENSE ./debian/copyright
      debchange --create "Autogenerated" --newversion=$VER --package "slidge"
      # git checkout -B debian-package
      # gbp dch --release --debian-branch debian-package
      dpkg-buildpackage -us -uc -b
  - test: |
      sudo apt-get install ./slidge_${VER}_arm64.deb -y
      ls -la /usr/lib/slidge*
      sudo ls -la /etc/slidge*
      sudo mv /etc/slidge/conf.d/common.conf.example /etc/slidge/conf.d/common.conf
      sudo mv /etc/slidge/whatsapp.conf.example /etc/slidge/whatsapp.conf
      sudo systemctl cat slidge@whatsapp.service
      slidge --help
      sudo systemctl enable --now slidge@whatsapp
      sleep 15
      sudo journalctl -u slidge@whatsapp --since yesterday
  - tar: |
      tar cf slidge-debian-arm64.tar slidge-* slidge_*
      mv slidge_${VER}_arm64.deb slidge-latest-arm64.deb
