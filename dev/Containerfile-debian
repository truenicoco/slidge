# docker container to build the debian packages

FROM docker.io/nicocool84/slidge-debian-builder:latest AS builder

# conf files
WORKDIR /build/debian
COPY ./debian /build/debian
COPY ./LICENSE /build/
RUN mkdir -p etc
RUN for PLUGIN in $PLUGINS; do \
     sed "s/--PLUGIN--/$PLUGIN/" tpl.conf > etc/$PLUGIN.conf.example; \
    done

COPY ./requirements.txt /build/requirements.txt
COPY ./slidge /build/slidge

# gopy build
WORKDIR /build/slidge
RUN find . -name go.mod -execdir gopy build -vm=python3 -output=generated -no-make=true . ';'

# create .deb
WORKDIR /build/
ARG VER
RUN sed "s/__version__ = get_version()/__version__ = \"$VER\"/" -i slidge/__main__.py
RUN debchange --create "Autogenerated" --newversion=$VER --package "slidge"
COPY ./pyproject.toml /build/
COPY ./README.md /build/

# strip the build.py part of the package or we hit:
# Could not build wheels for slidge which use PEP 517 and cannot be installed directly
# (probably outdated pip in debian bullseye)
RUN grep -v '\[tool.poetry.build\]' pyproject.toml > pyproject.toml.1
RUN grep -v 'script = ' pyproject.toml.1 > pyproject.toml.2
RUN grep -v 'generate-setup-file =' pyproject.toml.2 > pyproject.toml.3
RUN mv pyproject.toml.3 pyproject.toml
RUN dpkg-buildpackage -us -uc -b

# test
WORKDIR /
RUN apt-get install ./slidge_${VER}_*.deb -y
RUN ls -la /usr/lib/slidge*
RUN ls -la /etc/slidge*
RUN mv /etc/slidge/conf.d/common.conf.example /etc/slidge/conf.d/common.conf
RUN mv /etc/slidge/whatsapp.conf.example /etc/slidge/whatsapp.conf
RUN slidge --help

FROM scratch AS out
COPY --from=builder /slidge* /